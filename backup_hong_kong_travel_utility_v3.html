<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦™æ¸¯éŠ - æ—¥å¼ç°¡ç´„é¢¨è¡Œç¨‹èˆ‡è¨˜å¸³</title>
    <!-- è¼‰å…¥ Tailwind CSS (CDN æ–¹å¼ï¼Œç°¡åŒ–éƒ¨ç½²) --><script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­ç½®å­—é«”ç‚º Noto Sans TC (ç¹é«”ä¸­æ–‡) --><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #F5F3ED; /* å¥¶èŒ¶è‰² (æ·ºæš–ç±³è‰²) */
            -webkit-overflow-scrolling: touch;
        }
        .app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff; /* å…§å®¹å€å¡Šç‚ºç´”ç™½ */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05); /* è¼•å¾®çš„æ•´é«”é™°å½± */
        }
        .light-header {
            background-color: #ffffff;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
        }
        .light-header h1 {
            color: #1f2937;
            font-weight: 900;
        }

        /* éŸ¿æ‡‰å¼æ—¥æœŸæ»¾å‹•æ¢æ¨£å¼ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #day-navigation { @apply flex overflow-x-scroll snap-x snap-mandatory no-scrollbar p-1; }
        .day-item-inner { @apply p-3 md:p-4 text-center rounded-xl font-bold transition duration-300 transform active:scale-95 border-2; }
        .day-item-inner.active { @apply bg-blue-600 text-white shadow-lg border-blue-600; }
        .day-item-inner.inactive { @apply bg-white text-gray-700 hover:bg-gray-50 border-gray-100; }

        /* å‚ç›´è¡Œç¨‹æ™‚é–“ç·šå¡ç‰‡æ¨£å¼ */
        .itinerary-item { @apply relative pl-10 pb-8; }
        .itinerary-item::before { /* æ™‚é–“ç·šé» */
            content: ''; position: absolute; top: 5px; left: 0;
            width: 10px; height: 10px; border-radius: 50%;
            background-color: #e5e7eb; z-index: 10;
        }
        .itinerary-item::after { /* æ™‚é–“ç·šç·šæ¢ */
            content: ''; position: absolute; top: 15px; left: 4px;
            width: 2px; height: 100%; background-color: #e5e7eb; z-index: 5;
        }
        .itinerary-item:last-child::after { display: none; } /* æœ€å¾Œä¸€å€‹é …ç›®ä¸é¡¯ç¤ºç·šæ¢ */
        
        .itinerary-card { @apply p-4 bg-white rounded-xl shadow-lg transition duration-300 relative border-l-4 border-t border-r; }
        .card-attraction { border-left-color: #F472B6; border-color: #FCE7F6; }
        .card-transport { border-left-color: #60A5FA; border-color: #E0F2FE; }

        /* Loading Dots */
        .loading-dot { animation: bounce 1s infinite; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body>

<div id="app" class="app-container">

    <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡ç¸½èŠ±è²» --><header id="main-header" class="pt-6 pb-2 sticky top-0 light-header z-20 shadow-md">
        <h1 class="text-3xl text-center tracking-wider">é¦™æ¸¯éŠ</h1>
        <div class="flex justify-between items-center px-4 mt-3 pb-2">
            <p class="text-xs text-gray-400">ç‹€æ…‹: <span id="auth-status">è¼‰å…¥ä¸­...</span></p>
            <p class="text-xl font-extrabold text-red-500">ç¸½èŠ±è²»: <span id="grand-total">HK$ 0.00</span></p>
        </div>
    </header>
    
    <!-- æ¯æ—¥è¡Œç¨‹åˆ‡æ›å°èˆª --><nav id="day-nav-bar" class="sticky light-header pt-2 pb-2 z-10 shadow-sm">
        <div id="day-navigation" class="flex overflow-x-scroll snap-x snap-mandatory no-scrollbar p-1">
            <!-- æ—¥æœŸé …ç›®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ --></div>
    </nav>

    <!-- è¡Œç¨‹å¡ç‰‡å®¹å™¨ --><div id="itinerary-cards" class="p-4 pt-6">
        <p id="loading-message" class="text-center text-gray-400 mt-10">æ­£åœ¨åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼å’Œè³‡æ–™åº«...</p>
    </div>

</div>

<script type="module">
    // --- 0. Firebase & API Imports/Setup ---
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, addDoc, onSnapshot, serverTimestamp, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // =========================================================================
    // !!! IMPORTANT: FOR GITHUB PAGES, YOU MUST REPLACE THESE PLACEHOLDERS !!!
    // è«‹å°‡ YOUR_..._HERE æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆé…ç½®ï¼Œä»¥å•Ÿç”¨è¨˜å¸³åŠŸèƒ½ã€‚
    // å¦‚æœä¸æ›¿æ›ï¼Œæ‡‰ç”¨ç¨‹å¼å°‡ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«ã€‚
    // =========================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyDw5WU0O7emQgXcCpuA_LpOMsdP8Xalkpo",
        authDomain: "project-90335699733761631.firebaseapp.com",
        projectId: "project-90335699733761631", 
        storageBucket: "project-90335699733761631.firebasestorage.app",
        messagingSenderId: "201574697204",
        appId: "1:201574697204:web:c51b122cbe9977f732b6a1"
    };
    
    // é è¨­ App ID (ç”¨æ–¼ Firestore æ”¶è—å¤¾è·¯å¾‘)
    // å¦‚æœåœ¨ Canvas ç’°å¢ƒä¸­é‹è¡Œï¼Œæœƒä½¿ç”¨ Canvas æä¾›çš„ __app_idã€‚
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'hk-trip-planner';
    // èªè­‰ä»¤ç‰Œ (åœ¨ç¨ç«‹ç¶²ç«™ä¸Šé€šå¸¸ç‚º null)
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // API è¨­å®š (è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš› Gemini API é‡‘é‘°)
    const API_KEY = "YOUR_GEMINI_API_KEY"; // <<<<<<< è«‹æ›¿æ›æˆæ‚¨çš„ Gemini API é‡‘é‘°
    const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
    
    // å…¨åŸŸç‹€æ…‹
    let db, auth;
    let currentDay = 1;
    const INFO_PAGE_DAY = 5;
    let userId = null;
    let isAuthReady = false;
    const loadedContent = {};
    let expenses = [];
    let hkdToTwdRate = null;

    const dayLabels = { 1: "Day 1", 2: "Day 2", 3: "Day 3", 4: "Day 4", [INFO_PAGE_DAY]: "å¯¦ç”¨è³‡è¨Š" };

    const getExpensesCollection = (uid) => collection(db, `artifacts/${appId}/users/${uid}/expenses`);

    // --- 1. Firebase åˆå§‹åŒ–èˆ‡èªè­‰ ---

    async function initFirebase() {
        try {
            setLogLevel('Debug');
            
            // æª¢æŸ¥ Firebase Config æ˜¯å¦æœ‰è‡³å°‘æä¾› projectId (é¿å… 404 ä¹‹å¾Œçš„åˆå§‹åŒ–å¤±æ•—)
            if (!firebaseConfig.projectId || firebaseConfig.projectId.includes("YOUR_PROJECT_ID")) {
                const loadingMessage = document.getElementById('loading-message');
                loadingMessage.textContent = 'æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—ã€‚è«‹æª¢æŸ¥ç¨‹å¼ç¢¼ä¸­ç¬¬ 77 è¡Œå·¦å³çš„ Firebase é…ç½®ï¼Œä¸¦æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„ Project ID ç­‰ä¿¡æ¯ã€‚';
                console.error("Firebase initialization failed: projectId not provided or is a placeholder.");
                return; 
            }
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            const loadingMessage = document.getElementById('loading-message');
            loadingMessage.textContent = 'æ­£åœ¨é©—è­‰ç”¨æˆ¶èº«ä»½...';

            onAuthStateChanged(auth, async (user) => {
                const statusDisplay = document.getElementById('auth-status');
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    statusDisplay.textContent = 'å·²ç™»å…¥ (è¼‰å…¥åŒ¯ç‡ä¸­...)';
                    
                    await fetchExchangeRate();
                    
                    if (hkdToTwdRate) {
                        statusDisplay.textContent = `å·²ç™»å…¥ (1 HKD â‰ˆ NT$ ${hkdToTwdRate.toFixed(2)})`;
                    } else {
                        statusDisplay.textContent = 'å·²ç™»å…¥ (åŒ¯ç‡è¼‰å…¥å¤±æ•—)';
                    }
                    
                    loadingMessage.classList.add('hidden');
                    listenForExpenses();
                    renderNavigation();
                    renderItinerary();
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                            // åŒ¿åç™»å…¥æˆåŠŸå¾Œï¼ŒonAuthStateChanged æœƒå†æ¬¡è§¸ç™¼ï¼Œä¸¦é€²å…¥ if (user) å€å¡Š
                        }
                    } catch (error) {
                        console.error("Firebase Auth failed:", error);
                        loadingMessage.textContent = `èº«ä»½é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®ã€‚éŒ¯èª¤: ${error.message}`;
                    }
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('loading-message').textContent = `æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—ã€‚éŒ¯èª¤: ${error.message}`;
        }
    }

    // --- 2. åŒ¯ç‡ç²å–åŠŸèƒ½ (ä½¿ç”¨ Gemini API) ---

    async function fetchExchangeRate(retries = 3) {
        const query = "Current exchange rate of 1 Hong Kong Dollar (HKD) to New Taiwan Dollar (TWD). Provide the numerical value only, up to 4 decimal places.";
        const systemPrompt = "You are a precise data extraction tool. Respond ONLY with the numerical value for the current exchange rate, rounded to four decimal places. Do not include currency symbols or any explanatory text.";
        
        const payload = {
            contents: [{ parts: [{ text: query }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        // æª¢æŸ¥ API é‡‘é‘°æ˜¯å¦å·²è¨­å®š
        if (API_KEY.includes("YOUR_GEMINI_API_KEY")) {
             console.warn("Gemini API é‡‘é‘°æœªè¨­å®šã€‚è·³éåŒ¯ç‡ç²å–ã€‚");
             hkdToTwdRate = 4.0; // é è¨­å€¼
             return hkdToTwdRate;
        }

        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429) { // Too Many Requests
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                }
                
                if (!response.ok) throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    const rate = parseFloat(text.match(/[\d\.]+/)?.[0]);
                    if (!isNaN(rate) && rate > 0.1 && rate < 10) { // åˆç†æ€§æª¢æŸ¥
                        hkdToTwdRate = rate;
                        console.log(`Exchange Rate (HKD->TWD) fetched: ${hkdToTwdRate}`);
                        return rate;
                    }
                }
                console.warn("Failed to parse valid exchange rate from API response:", text);

            } catch (error) {
                console.error(`Attempt ${i + 1} failed for exchange rate:`, error.message);
                if (i === retries - 1) break;
                const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }

        if (hkdToTwdRate === null) {
            hkdToTwdRate = 4.0; // é è¨­å€¼
            console.warn(`ä½¿ç”¨é è¨­å‚™ç”¨åŒ¯ç‡: ${hkdToTwdRate}`);
        }
        return hkdToTwdRate;
    }


    // --- 3. Firestore è¨˜å¸³æ“ä½œ ---

    function listenForExpenses() {
        if (!isAuthReady || !userId) return;
        const expensesQuery = getExpensesCollection(userId);
        
        onSnapshot(expensesQuery, (snapshot) => {
            expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderItinerary();
            calculateGrandTotal();
        }, (error) => {
            console.error("Error listening to expenses:", error);
            document.getElementById('loading-message').textContent = `è³‡æ–™åº«é€£ç·šå¤±æ•—ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Firebase Security Rules æ˜¯å¦å…è¨±è®€å–ã€‚`;
            document.getElementById('loading-message').classList.remove('hidden');
        });
    }

    async function addExpense(day, item, amount) {
        if (!isAuthReady || !userId || !item || !amount) return;
        const amountFloat = parseFloat(amount);
        if (isNaN(amountFloat) || amountFloat <= 0) { console.warn("é‡‘é¡ç„¡æ•ˆã€‚"); return; }

        try {
            await addDoc(getExpensesCollection(userId), {
                day: day, item: item, amount: amountFloat, timestamp: serverTimestamp()
            });
        } catch (error) { console.error("Error adding document: ", error); }
    }

    async function deleteExpense(expenseId) {
        if (!isAuthReady || !userId || !expenseId) return;
        try {
            await deleteDoc(doc(getExpensesCollection(userId), expenseId));
        } catch (error) { console.error("Error deleting document: ", error); }
    }
    
    // --- 4. æ ¸å¿ƒåŠŸèƒ½èˆ‡æ¸²æŸ“ ---

    function calculateGrandTotal() {
        const totalHKD = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        let grandTotalDisplay = `HK$ ${totalHKD.toFixed(2)}`;
        
        if (hkdToTwdRate) {
            const totalTWD = totalHKD * hkdToTwdRate;
            grandTotalDisplay += ` / NT$ ${totalTWD.toFixed(0)}`;
        }
        document.getElementById('grand-total').textContent = grandTotalDisplay;
        // ç¢ºä¿å°èˆªæ¬„çš„ sticky top è¨­å®šæ­£ç¢º
        document.getElementById('day-nav-bar').style.top = `${document.getElementById('main-header').offsetHeight}px`;
    }

    function switchDay(day) {
        currentDay = day;
        renderNavigation(); // é‡æ–°æ¸²æŸ“å°èˆªä»¥æ›´æ–°é¸ä¸­ç‹€æ…‹
        renderItinerary();
    }
    
    // è¡Œç¨‹æ•¸æ“š (ä¿æŒä¸è®Š)
    const itinerary = [
        {
            day: 1, date: "Day 1",
            items: [
                { time: "11:00", type: "transport", name: "é¦™æ¸¯èˆªç©º", detail: "æŠµé”é¦™æ¸¯åœ‹éš›æ©Ÿå ´ï¼Œå‡ç´šå•†å‹™è‰™", icon: "âœˆï¸" },
                { time: "12:00", type: "transport", name: "A11 å·´å£«", detail: "æ­ä¹˜å…¬è»Šå‰å¾€ä¸Šç’°é£¯åº—", icon: "ğŸšŒ" },
                { time: "13:00", type: "attraction", name: "å¯Œè•™ä¸Šç’°é…’åº— (Check-in)", detail: "è¾¦ç†å…¥ä½æ‰‹çºŒ", icon: "ğŸ¨" },
                { time: "14:00", type: "attraction", name: "è˜­èŠ³åœ’ (ä¸­ç’°)", detail: "å–ç¶“å…¸çµ²è¥ªå¥¶èŒ¶æˆ–å‡é£²", icon: "ğŸ¥¤" },
                { time: "14:30", type: "attraction", name: "ä¸€æ¨‚ç‡’é´¨", detail: "ç±³å…¶æ—æ¨è–¦ç‡’è‡˜åˆé¤", icon: "ğŸ–" },
                { time: "16:00", type: "attraction", name: "ä¸­ç’°è¡—å¸‚", detail: "åƒè§€æ´»åŒ–æ­·å²å»ºç¯‰èˆ‡ç‰¹è‰²å°åº—", icon: "ğŸ›ï¸" },
                { time: "17:30", type: "attraction", name: "å¤§é¤¨ (ç›£ç„èˆŠå€)", detail: "è—è¡“ã€æ­·å²ã€chill çš„å¥½åœ°æ–¹", icon: "ğŸ›ï¸" },
                { time: "20:00", type: "attraction", name: "æ¥šç„¶è¨˜å¤§æ’æª”", detail: "é«”é©—åœ°é“æ¸¯å¼æ™šé¤", icon: "ğŸœ" },
            ]
        },
        {
            day: 2, date: "Day 2",
            items: [
                { time: "09:30", type: "transport", name: "åœ°éµ", detail: "å‰å¾€å …å°¼åœ°åŸ", icon: "ğŸš‡" },
                { time: "10:00", type: "attraction", name: "å …å°¼åœ°åŸæµ·æ—", detail: "ç¶²ç¾æ‹ç…§æ‰“å¡é»", icon: "ğŸ“¸" },
                { time: "11:30", type: "transport", name: "æ­èˆ¹ (æ¸¯æ¾³ç¢¼é ­)", detail: "å‰å¾€æ¾³é–€æ°¹ä»”å®¢é‹ç¢¼é ­", icon: "ğŸš¢" },
                { time: "13:00", type: "attraction", name: "åˆ©è»’å†°å®¤ (æ¾³é–€)", detail: "æ¾³é–€èŒ¶é¤å»³ç¾é£Ÿåˆé¤", icon: "ğŸ½ï¸" },
                { time: "15:00", type: "attraction", name: "å¨å°¼æ–¯äººé…’åº— (æ¾³é–€)", detail: "å®‰å¾·é­¯è›‹æ’» & è³­ $100 å°è©¦æ‰‹æ°£", icon: "ğŸ°" },
                { time: "17:00", type: "transport", name: "æ¥é§è»Š", detail: "å¾€æ¾³é–€å¤–æ¸¯ç¢¼é ­æº–å‚™å›ç¨‹", icon: "ğŸšŒ" },
                { time: "19:00", type: "attraction", name: "é‡‘ç¾é£Ÿ & æé¦™åœ’ (æ¾³é–€)", detail: "æ™šé¤æ›¿ä»£é¸æ“‡", icon: "ğŸ²" },
                { time: "21:00", type: "transport", name: "æ¸¯ç æ¾³å¤§æ©‹ (é‡‘å±±å·´å£«)", detail: "æ­é‡‘å±±å·´å£«å›é¦™æ¸¯ (å…¥å¢ƒå°æ’æ›²)", icon: "ğŸŒ‰" },
                { time: "22:30", type: "transport", name: "A11 å·´å£«", detail: "å›ä¸Šç’°é£¯åº—ä¼‘æ¯", icon: "ğŸ¨" },
            ]
        },
        {
            day: 3, date: "Day 3",
            items: [
                { time: "09:00", type: "attraction", name: "ç‘è¨˜å’–å•¡ (ä¸Šç’°)", detail: "æ—©é¤ (å¥¶èŒ¶ã€è¥¿å¤šå£«)", icon: "ğŸ¥ª" },
                { time: "10:30", type: "transport", name: "åœ°éµ", detail: "å‰å¾€æ—ºè§’/å¤ªå­ä¸€å¸¶", icon: "ğŸš‡" },
                { time: "11:00", type: "attraction", name: "æ—¦ç‹ & æ¤°æ±å¤§ç‹", detail: "æ—ºè§’è¡—é ­å°åƒå·¡ç¦®", icon: "ğŸ¥š" },
                { time: "12:30", type: "attraction", name: "é»‘åœ° (Blackground) & å¤ªå­", detail: "æ½®æµæœé£¾ã€ç‰¹è‰²å°åº—é€›è¡—", icon: "ğŸ‘•" },
                { time: "14:00", type: "attraction", name: "TWEMCO ç¿»é é˜", detail: "è³¼è²·ç¶“å…¸è¨­è¨ˆæ™‚é˜", icon: "ğŸ•°ï¸" },
                { time: "16:00", type: "attraction", name: "K11 MUSEA (å°–æ²™å’€)", detail: "åƒè§€å•†å ´ã€æ½®æµè—è¡“å±•è¦½", icon: "ğŸ–¼ï¸" },
                { time: "17:30", type: "attraction", name: "ç´…èŒ¶ (Tea)", detail: "ç²¾ç·»ä¸‹åˆèŒ¶æˆ–é£²æ–™", icon: "â˜•" },
                { time: "19:30", type: "attraction", name: "åœ°èŒ‚é¤¨ç”œå“", detail: "æ™šé¤å¾Œçš„æ¸¯å¼ç”œé»æ™‚é–“", icon: "ğŸ§" },
            ]
        },
        {
            day: 4, date: "Day 4",
            items: [
                { time: "09:00", type: "attraction", name: "ç§‘è¨˜å’–å•¡èŒ¶å»³ (ä¸Šç’°)", detail: "æ—©é¤ (è±¬æ‰’åŒ…ã€è”¥æ²¹æ’ˆéºµ)", icon: "ğŸ¥–" },
                { time: "10:30", type: "attraction", name: "æ¾³æ´²ç‰›å¥¶å…¬å¸ (ä½æ•¦)", detail: "å¿…åƒæ‹›ç‰Œç‚’è›‹å¤šå£« (çœŸçš„è®š)", icon: "ğŸ³" },
                { time: "12:00", type: "attraction", name: "K11 hashtag B", detail: "å†è¨ªï¼Œçµ‚æ–¼è²·åˆ°è›‹å¡”ï¼", icon: "ğŸ¥§" },
                { time: "13:30", type: "attraction", name: "è¯å«‚ & å¸è‹‘é¤…åº—", detail: "å¤–å¸¶è¯å«‚ç¾é£Ÿï¼Œè³¼è²·è´è¶é…¥ä¼´æ‰‹ç¦®", icon: "ğŸ¥¡" },
                { time: "15:00", type: "transport", name: "å›ç¨‹", detail: "å‰å¾€æ©Ÿå ´æº–å‚™ç™»æ©Ÿï¼Œæ—…ç¨‹çµæŸ", icon: "ğŸ›«" },
            ]
        },
        {
            day: INFO_PAGE_DAY, date: "Day 5", items: []
        }
    ];
    
    const toolInfoContent = `
        <div class="space-y-4">
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-700">ç°½è­‰èˆ‡æ–‡ä»¶ (é¦™æ¸¯)</span>
                <p class="mt-2 text-sm leading-relaxed text-gray-700">å°ç£æ—…å®¢ï¼šæŒæœ‰æ•ˆè­‰ä»¶ï¼ˆå¦‚å°èƒè­‰æˆ–è­·ç…§+ç¶²ä¸Šé è¾¦å…¥å¢ƒç™»è¨˜ï¼‰ï¼Œé€šå¸¸å¯å…ç°½åœç•™7è‡³30å¤©ã€‚**Day 2 æé†’æ‚¨ï¼Œå…¥å¢ƒæ–‡ä»¶å½±æœ¬æˆ–é›»å­æª”æœ€å¥½å‚™å¦¥ï¼Œä»¥é˜²æŸ¥é©—éœ€è¦ã€‚**</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-700">è¡£è‘—å»ºè­°</span>
                <p class="mt-2 text-sm leading-relaxed text-gray-700">é¦™æ¸¯åœ°éµèˆ‡å•†å ´å†·æ°£æ¥µå¼·ï¼Œå»ºè­°æ¡ç”¨**å¤šå±¤æ¬¡ç©¿æ­**ã€‚éš¨èº«æ”œå¸¶è–„å¤–å¥—æ˜¯å¿…é ˆçš„ï¼</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-700">ç¶²è·¯é›»ä¿¡æ¨è–¦</span>
                <p class="mt-2 text-sm leading-relaxed text-gray-700">æ¨è–¦ä½¿ç”¨ **eSIM (å¦‚ Airalo)** æˆ–åœ¨æ©Ÿå ´/ä¾¿åˆ©åº—è³¼è²·ç•¶åœ°çš„é ä»˜å¡ (å¦‚ csl, 3HK)ï¼Œç¢ºä¿ç¶²è·¯é †æš¢ã€‚</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-700">é˜²é¨™ç§˜ç¬ˆ</span>
                <p class="mt-2 text-sm leading-relaxed text-gray-700">1. **æ‰¾é›¶ï¼š** åœ¨èˆŠå¼èŒ¶é¤å»³æˆ–è¡—é‚Šæ”¤è²©ä»˜ç¾é‡‘ï¼Œå‹™å¿…ç•¶é¢é»æ¸…æ‰¾é›¶ã€‚2. **è³¼ç‰©ï¼š** è³¼è²·é›»å­ç”¢å“è«‹é¸æ“‡å¤§å‹ã€ä¿¡è­½è‰¯å¥½çš„é€£é–åº—ã€‚</p>
            </div>
             <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-pink-100 text-pink-700">å¿…è²·ç´€å¿µå“ä¼´æ‰‹ç¦®</span>
                <p class="mt-2 text-sm leading-relaxed text-gray-700">æ‚¨çš„è¡Œç¨‹å·²åŒ…å«ï¼š**å¸è‹‘é¤…åº—è´è¶é…¥**ï¼ˆå¼·çƒˆæ¨è–¦ï¼ï¼‰ã€‚å…¶ä»–å¯è€ƒæ…®ï¼šçå¦®æ›²å¥‡ã€æª¸æª¬ç‹ã€‚</p>
            </div>
        </div>
    `;

    function selectDay(element, day) {
        document.querySelectorAll('.day-item-inner').forEach(item => {
            item.classList.remove('active');
            item.classList.add('inactive');
        });
        element.classList.add('active');
        element.classList.remove('inactive');
        element.parentElement.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        if (currentDay !== day) { switchDay(day); }
    }

    function renderNavigation() {
        const navContainer = document.getElementById('day-navigation');
        navContainer.innerHTML = '';
        
        const daysToRender = [1, 2, 3, 4, INFO_PAGE_DAY];
        daysToRender.forEach((day) => {
            const label = dayLabels[day];
            const isCurrent = day === currentDay;
            const dateItem = document.createElement('div');
            dateItem.className = `day-item w-1/5 flex-shrink-0 snap-center p-1 md:p-2 cursor-pointer transition duration-200 transform`;
            const innerContent = document.createElement('div');
            innerContent.className = `day-item-inner ${isCurrent ? 'active' : 'inactive'}`;
            innerContent.innerHTML = `<span class="text-base">${label}</span>`;
            innerContent.onclick = () => selectDay(innerContent, day);
            dateItem.appendChild(innerContent);
            navContainer.appendChild(dateItem);
        });

        calculateGrandTotal(); 
        const firstDayElement = navContainer.querySelector('.day-item-inner.active');
        if (firstDayElement) {
            firstDayElement.parentElement.scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
        }
    }

    function renderItinerary() {
        if (!isAuthReady) return; 
        const container = document.getElementById('itinerary-cards');
        container.innerHTML = '';

        if (currentDay === INFO_PAGE_DAY) {
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 bg-white rounded-xl shadow-lg border border-gray-100">
                        <h2 class="text-xl font-bold text-gray-800 pb-2 border-b border-gray-200 flex items-center mb-4 text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                            é¦™æ¸¯æ—…éŠå¯¦ç”¨è³‡è¨Š
                        </h2>
                        ${toolInfoContent}
                    </div>
                </div>
            `;
            return;
        }

        const dayPlan = itinerary.find(d => d.day === currentDay);
        if (!dayPlan) return;

        const itineraryList = document.createElement('div');
        itineraryList.className = 'space-y-2';
        
        dayPlan.items.forEach((item, index) => {
            const isAttraction = item.type === 'attraction';
            const itemContainer = document.createElement('div');
            itemContainer.className = 'itinerary-item';
            const card = document.createElement('div');
            card.id = `item-${dayPlan.day}-${index}`;
            const cardBorderColor = isAttraction ? 'card-attraction' : 'card-transport';
            card.className = `itinerary-card ${cardBorderColor}`;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <p class="text-xs font-medium text-gray-400 mb-0.5">æ™‚é–“</p>
                        <p class="text-2xl font-extrabold text-gray-800 leading-none">${item.time}</p>
                    </div>
                    <span class="text-3xl flex-shrink-0">${item.icon}</span>
                </div>
                
                <h3 class="text-base font-bold text-gray-800 mt-2">${item.name}</h3>
                <p class="text-sm text-gray-500 mt-1">${item.detail}</p>
                
                ${isAttraction ? `
                    <button class='text-pink-600 hover:text-pink-700 focus:outline-none text-xs mt-3 px-3 py-1 border border-pink-600 rounded-full transition duration-150 flex-shrink-0 bg-pink-50/50 active:scale-95' 
                            onclick="toggleInfo('info-${dayPlan.day}-${index}', '${item.name}', this, 'item-${dayPlan.day}-${index}')">
                        æ•…äº‹ ğŸ”½
                    </button>` : ''}
            `;
            if (isAttraction) {
                const infoPanel = document.createElement('div');
                infoPanel.id = `info-${dayPlan.day}-${index}`;
                infoPanel.className = 'mt-3 pt-3 border-t border-gray-100 text-sm hidden w-full';
                card.appendChild(infoPanel);
            }
            itemContainer.appendChild(card);
            itineraryList.appendChild(itemContainer);
        });
        
        container.appendChild(itineraryList);
        const budgetWrapper = document.createElement('div');
        budgetWrapper.className = 'mt-8 pb-10';
        budgetWrapper.appendChild(renderBudgetSection(dayPlan));
        container.appendChild(budgetWrapper);
    }

    function renderBudgetSection(dayPlan) {
        const day = dayPlan.day; 
        const section = document.createElement('section');
        section.className = 'p-5 bg-gray-50 rounded-xl shadow-inner border border-gray-200 space-y-4';
        
        const dayExpenses = expenses.filter(e => e.day === day).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        const dailyTotalHKD = dayExpenses.reduce((sum, e) => sum + e.amount, 0);

        let dailyTotalDisplay = `ç¸½è¨ˆ: HK$ ${dailyTotalHKD.toFixed(2)}`;
        let twdRateDisplay = '';
        if (hkdToTwdRate) {
            const dailyTotalTWD = dailyTotalHKD * hkdToTwdRate;
            dailyTotalDisplay += ` / NT$ ${dailyTotalTWD.toFixed(0)}`;
            twdRateDisplay = `(1 HKD â‰ˆ NT$ ${hkdToTwdRate.toFixed(2)})`;
        }

        let expensesListHTML = dayExpenses.map(e => `
            <div class="flex justify-between items-center py-1 border-b border-gray-100 last:border-b-0">
                <span class="text-gray-700 text-sm">${e.item}</span>
                <div class="flex items-center space-x-2">
                    <span class="font-semibold text-red-600 text-sm">HK$ ${e.amount.toFixed(2)}</span>
                    <button class="text-gray-400 hover:text-red-500 transition duration-150" onclick="deleteExpense('${e.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');

        if (expensesListHTML.length === 0) {
            expensesListHTML = `<p class="text-center text-gray-400 py-4">ä»Šå¤©é‚„æ²’æœ‰è¨˜å¸³å“¦ï¼</p>`;
        }

        section.innerHTML = `
            <div class="flex justify-between items-start pb-2 border-b border-gray-300">
                <div>
                    <h3 class="text-lg font-bold text-gray-800 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2 -mt-0.5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2 2v4a2 2 0 002 2h2a2 2 0 002-2V6a2 2 0 00-2-2H4zm10 8V6h2v6h-2z" clip-rule="evenodd" />
                        </svg>
                        ${dayLabels[day]} è¨˜å¸³æœ¬
                    </h3>
                    <p class="text-xs text-gray-400 mt-1">${twdRateDisplay}</p>
                </div>
                <span class="text-xl font-extrabold text-red-500">${dailyTotalDisplay}</span>
            </div>

            <div class="space-y-3 p-3 bg-white rounded-lg shadow-sm">
                <form id="add-expense-form-${day}" class="flex space-x-2 items-center">
                    <input type="text" id="expense-item-${day}" placeholder="é …ç›® (e.g. åˆé¤)" required
                           class="flex-1 p-2 border border-gray-200 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                    <input type="number" id="expense-amount-${day}" placeholder="é‡‘é¡ (HK$)" required min="0.01" step="0.01"
                           class="w-24 p-2 border border-gray-200 rounded-lg text-sm text-right focus:ring-blue-500 focus:border-blue-500">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition duration-150 transform active:scale-95 text-sm font-semibold flex-shrink-0">
                        æ–°å¢
                    </button>
                </form>
            </div>
            
            <div id="expenses-list-${day}" class="bg-white rounded-lg p-3 border border-gray-100">
                ${expensesListHTML}
            </div>
        `;
        
        // è¨­å®šè¡¨å–®æäº¤äº‹ä»¶
        section.querySelector(`#add-expense-form-${day}`).onsubmit = function(e) {
            e.preventDefault();
            const itemInput = document.getElementById(`expense-item-${day}`);
            const amountInput = document.getElementById(`expense-amount-${day}`);
            addExpense(day, itemInput.value, amountInput.value);
            itemInput.value = '';
            amountInput.value = '';
        };

        return section;
    }

    // --- 5. æ™¯é»æ•…äº‹æŸ¥è©¢åŠŸèƒ½ ---

    window.toggleInfo = async function(infoId, attractionName, button, cardId) {
        const infoPanel = document.getElementById(infoId);
        const card = document.getElementById(cardId);

        if (infoPanel.classList.contains('hidden')) {
            // å±•é–‹
            button.innerHTML = 'æ•…äº‹ ğŸ”¼';
            card.classList.add('shadow-xl'); // å±•é–‹æ™‚å¼·èª¿é™°å½±
            infoPanel.classList.remove('hidden');

            if (loadedContent[attractionName]) {
                // å¦‚æœå·²ç¶“è¼‰å…¥éï¼Œç›´æ¥é¡¯ç¤º
                infoPanel.innerHTML = loadedContent[attractionName];
            } else {
                // å¦å‰‡ï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­ä¸¦èª¿ç”¨ API
                infoPanel.innerHTML = `
                    <div class="flex justify-center items-center py-4 text-gray-500">
                        <span class="loading-dot w-2 h-2 bg-pink-500 rounded-full mr-1"></span>
                        <span class="loading-dot w-2 h-2 bg-pink-500 rounded-full mr-1"></span>
                        <span class="loading-dot w-2 h-2 bg-pink-500 rounded-full"></span>
                        <span class="ml-2">æ­£åœ¨ç‚ºæ‚¨æŸ¥è©¢ ${attractionName} çš„æ•…äº‹...</span>
                    </div>
                `;
                const story = await fetchStory(attractionName);
                const htmlContent = `
                    <h4 class="font-bold text-pink-600 mb-1">æ­·å² / è¶£è</h4>
                    <p class="text-gray-600 leading-relaxed">${story}</p>
                `;
                loadedContent[attractionName] = htmlContent;
                infoPanel.innerHTML = htmlContent;
            }
        } else {
            // æ”¶åˆ
            button.innerHTML = 'æ•…äº‹ ğŸ”½';
            card.classList.remove('shadow-xl');
            infoPanel.classList.add('hidden');
        }
    }

    async function fetchStory(attractionName, retries = 3) {
        const query = `Provide a fun fact, a brief history, or a local story about the Hong Kong location: ${attractionName}. The response must be a single, interesting paragraph suitable for a travel guide. Respond in Traditional Chinese.`;
        
        const payload = {
            contents: [{ parts: [{ text: query }] }],
            tools: [{ "google_search": {} }],
        };
        
        // æª¢æŸ¥ API é‡‘é‘°æ˜¯å¦å·²è¨­å®š
        if (API_KEY.includes("YOUR_GEMINI_API_KEY")) {
             return `è«‹åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šæ‚¨çš„ Gemini API é‡‘é‘° (åœ¨ç¬¬ 91 è¡Œå·¦å³)ï¼Œæ‰èƒ½å•Ÿç”¨ AI æ•…äº‹æŸ¥è©¢åŠŸèƒ½ã€‚`;
        }

        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429) { // Too Many Requests
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                }

                if (!response.ok) throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    return text.trim();
                }

            } catch (error) {
                console.error(`Attempt ${i + 1} failed for story of ${attractionName}:`, error.message);
                if (i === retries - 1) break;
                const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }

        return `æŠ±æ­‰ï¼Œç›®å‰ç„¡æ³•è¼‰å…¥ ${attractionName} çš„æ•…äº‹ã€‚è«‹ç¨å¾Œå†è©¦ã€‚`;
    }

    // å°‡ deleteExpense æš´éœ²çµ¦å…¨åŸŸ window
    window.deleteExpense = deleteExpense;
    
    // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
    initFirebase();
</script>
</body>
</html>
