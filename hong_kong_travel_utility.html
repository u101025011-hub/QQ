<!-- å¼·åˆ¶é‡æ–°éƒ¨ç½²æ¸¬è©¦ -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦™æ¸¯éŠ - è¡Œç¨‹è¦åŠƒèˆ‡è¨˜å¸³</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­ç½®å­—é«”ç‚º Noto Sans TC (ç¹é«”ä¸­æ–‡) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #F5F3ED; /* å¥¶èŒ¶è‰² (æ·ºæš–ç±³è‰²) */
            -webkit-overflow-scrolling: touch;
        }
        .app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff; /* å…§å®¹å€å¡Šç‚ºç´”ç™½ */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05); /* è¼•å¾®çš„æ•´é«”é™°å½± */
        }

        /* é ‚éƒ¨ Header & Nav Bar æ¨£å¼ - ç°¡ç´„ç™½è‰²ä¸»é¡Œ */
        .light-header {
            background-color: #ffffff;
            color: #333;
            border-bottom: 1px solid #f0f0f0; /* ä¹¾æ·¨çš„åˆ†éš”ç·š */
        }
        .light-header h1 {
            color: #1f2937; /* æ·±ç°æ¨™é¡Œ */
            font-weight: 900;
        }
        
        /* --- éŸ¿æ‡‰å¼æ—¥æœŸæ»¾å‹•æ¢æ¨£å¼ --- */
        /* éš±è—æ»¾å‹•æ¢ï¼Œä½†åœ¨åŠŸèƒ½ä¸Šä»å¯æ»¾å‹• */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* æ ¸å¿ƒï¼šæ¯å€‹é …ç›®éƒ½æ˜¯ w-1/5 å¯¬ï¼Œä¸¦å¼·åˆ¶å¸é™„åˆ°ä¸­å¤® */
        #day-navigation {
            @apply flex overflow-x-scroll snap-x snap-mandatory no-scrollbar p-1;
        }
        .day-item-inner {
            /* è®“å…§å±¤æœ‰è¶³å¤ çš„ padding ç”¢ç”Ÿé–“è· */
            @apply p-3 md:p-4 text-center rounded-xl font-bold transition duration-300 transform active:scale-95 border-2;
        }
        /* ç¢ºä¿é¸ä¸­ç‹€æ…‹ä½¿ç”¨ app çš„è—è‰² */
        .day-item-inner.active {
            @apply bg-blue-600 text-white shadow-lg border-blue-600;
        }
        .day-item-inner.inactive {
            @apply bg-white text-gray-700 hover:bg-gray-50 border-gray-100;
        }


        /* --- å‚ç›´è¡Œç¨‹æ™‚é–“ç·šå¡ç‰‡æ¨£å¼ --- */
        .itinerary-item {
            @apply relative pl-10 pb-8;
        }
        /* æ™‚é–“ç·šé» */
        .itinerary-item::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #e5e7eb; /* ç°è‰²é» */
            z-index: 10;
        }
        /* æ™‚é–“ç·šç·šæ¢ */
        .itinerary-item::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 4px;
            width: 2px;
            height: 100%;
            background-color: #e5e7eb; /* ç°è‰²ç·š */
            z-index: 5;
        }
        /* æœ€å¾Œä¸€å€‹é …ç›®ä¸é¡¯ç¤ºç·šæ¢ */
        .itinerary-item:last-child::after {
            display: none;
        }
        
        /* å¡ç‰‡æœ¬é«” */
        .itinerary-card {
            @apply p-4 bg-white rounded-xl shadow-lg transition duration-300 relative border-l-4 border-t border-r;
        }
        .card-attraction { 
            border-left-color: #F472B6; /* è»Ÿç²‰è‰² */
            border-color: #FCE7F6;
        } 
        .card-transport { 
            border-left-color: #60A5FA; /* è»Ÿè—è‰² */
            border-color: #E0F2FE;
        }

        /* Loading Dots */
        .loading-dot { animation: bounce 1s infinite; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body>

<div id="app" class="app-container">

    <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡ç¸½èŠ±è²» (å›ºå®šåœ¨æœ€ä¸Šå±¤) -->
    <header id="main-header" class="pt-6 pb-2 sticky top-0 light-header z-20 shadow-md">
        <h1 class="text-3xl text-center tracking-wider">é¦™æ¸¯éŠ</h1>
        <div class="flex justify-between items-center px-4 mt-3 pb-2">
            <!-- é¡¯ç¤ºç™»å…¥ç‹€æ…‹èˆ‡åŒ¯ç‡è³‡è¨Š -->
            <p class="text-xs text-gray-400">ç‹€æ…‹: <span id="auth-status">è¼‰å…¥ä¸­...</span></p>
            <!-- é¡¯ç¤ºç¸½èŠ±è²» (HKD / TWD) -->
            <p class="text-xl font-extrabold text-red-500">ç¸½èŠ±è²»: <span id="grand-total">HK$ 0.00</span></p>
        </div>
    </header>
    
    <!-- æ¯æ—¥è¡Œç¨‹åˆ‡æ›å°èˆª (ä½¿ç”¨äº”ç­‰åˆ†æ»¾å‹•é¸æ“‡å™¨) -->
    <nav id="day-nav-bar" class="sticky light-header pt-2 pb-2 z-10 shadow-sm">
        <!-- NEW: äº”ç­‰åˆ†æ»¾å‹•å®¹å™¨ -->
        <div id="day-navigation" class="flex overflow-x-scroll snap-x snap-mandatory no-scrollbar p-1">
            <!-- æ—¥æœŸé …ç›®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆä¸¦æ’å…¥åˆ°æ­¤è™• (w-1/5) -->
        </div>
    </nav>

    <!-- è¡Œç¨‹å¡ç‰‡å®¹å™¨ (ä¸»å…§å®¹å€) -->
    <div id="itinerary-cards" class="p-4 pt-6">
        <p id="loading-message" class="text-center text-gray-400 mt-10">æ­£åœ¨åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼å’Œè³‡æ–™åº«...</p>
    </div>

</div>

<script type="module">
    // --- 0. Firebase & API Imports/Setup ---
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, addDoc, onSnapshot, serverTimestamp, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // å¼·åˆ¶ä½¿ç”¨å…¨åŸŸæä¾›çš„è®Šæ•¸
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'hk-trip-planner';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // API è¨­å®š
    const API_KEY = "";
    const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
    
    // å…¨åŸŸç‹€æ…‹
    let db, auth;
    let currentDay = 1; // é è¨­å¾ Day 1 é–‹å§‹
    const INFO_PAGE_DAY = 5; // å®šç¾©å¯¦ç”¨è³‡è¨Šçš„åˆ†é  ID
    let userId = null;
    let isAuthReady = false;
    const loadedContent = {}; // æ™¯é»æ•…äº‹ç·©å­˜
    let expenses = []; // è¨˜å¸³è³‡æ–™
    let hkdToTwdRate = null; // NEW: æ¸¯å¹£å…Œå°å¹£åŒ¯ç‡

    // å…¨åŸŸ Day æ¨™ç±¤ (èˆ‡è¡Œç¨‹è³‡æ–™å°æ‡‰)
    const dayLabels = { 1: "Day 1", 2: "Day 2", 3: "Day 3", 4: "Day 4", [INFO_PAGE_DAY]: "å¯¦ç”¨è³‡è¨Š" };

    // Firestore è·¯å¾‘å®šç¾© (ç§äººè³‡æ–™)
    const getExpensesCollection = (uid) => {
        // ä½¿ç”¨ private data path: /artifacts/{appId}/users/{userId}/expenses
        return collection(db, `artifacts/${appId}/users/${uid}/expenses`);
    };

    // --- 1. Firebase åˆå§‹åŒ–èˆ‡èªè­‰ ---

    async function initFirebase() {
        try {
            setLogLevel('Debug');
            
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            const loadingMessage = document.getElementById('loading-message');
            loadingMessage.textContent = 'æ­£åœ¨é©—è­‰ç”¨æˆ¶èº«ä»½...';

            onAuthStateChanged(auth, async (user) => {
                const statusDisplay = document.getElementById('auth-status');
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    
                    // 1. é¡¯ç¤ºè¼‰å…¥åŒ¯ç‡ç‹€æ…‹
                    statusDisplay.textContent = 'å·²ç™»å…¥ (è¼‰å…¥åŒ¯ç‡ä¸­...)';
                    
                    // 2. ç²å–æœ€æ–°åŒ¯ç‡
                    await fetchExchangeRate();
                    
                    // 3. æ›´æ–°æœ€çµ‚ç‹€æ…‹
                    if (hkdToTwdRate) {
                        statusDisplay.textContent = `å·²ç™»å…¥ (1 HKD â‰ˆ NT$ ${hkdToTwdRate.toFixed(2)})`;
                    } else {
                        statusDisplay.textContent = 'å·²ç™»å…¥ (åŒ¯ç‡è¼‰å…¥å¤±æ•—)';
                    }
                    
                    loadingMessage.classList.add('hidden');

                    // èº«ä»½é©—è­‰å®Œæˆå¾Œï¼Œæ‰å•Ÿå‹• Firestore ç›£è½èˆ‡æ¸²æŸ“
                    listenForExpenses();
                    renderNavigation();
                    renderItinerary();
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                            statusDisplay.textContent = 'åŒ¿åç™»å…¥';
                        }
                    } catch (error) {
                        console.error("Firebase Auth failed:", error);
                        loadingMessage.textContent = `èº«ä»½é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®ã€‚éŒ¯èª¤: ${error.message}`;
                    }
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('loading-message').textContent = `æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—ã€‚éŒ¯èª¤: ${error.message}`;
        }
    }

    // --- 2. åŒ¯ç‡ç²å–åŠŸèƒ½ (ä½¿ç”¨ Gemini API é€²è¡Œå³æ™‚æŸ¥è©¢) ---

    async function fetchExchangeRate(retries = 3) {
        // æŸ¥è©¢ç•¶å‰æ¸¯å¹£å…Œå°å¹£åŒ¯ç‡çš„æ•¸å€¼
        const query = "Current exchange rate of 1 Hong Kong Dollar (HKD) to New Taiwan Dollar (TWD). Provide the numerical value only, up to 4 decimal places.";
        
        // è¨­ç½®ç³»çµ±æŒ‡ä»¤ï¼Œè¦æ±‚æ¨¡å‹åªè¿”å›æ•¸å€¼
        const systemPrompt = "You are a precise data extraction tool. Respond ONLY with the numerical value for the current exchange rate, rounded to four decimal places. Do not include currency symbols or any explanatory text.";
        
        const payload = {
            contents: [{ parts: [{ text: query }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429) {
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                }
                
                if (!response.ok) {
                    throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    // å˜—è©¦å¾éŸ¿æ‡‰ä¸­è§£æå‡ºæµ®é»æ•¸ (å¿½ç•¥å‰å¾Œå¯èƒ½çš„æ–‡å­—æˆ–ç¬¦è™Ÿ)
                    const rate = parseFloat(text.match(/[\d\.]+/)?.[0]);

                    if (!isNaN(rate) && rate > 0.1 && rate < 10) { // åŸºæœ¬åˆç†æ€§æª¢æŸ¥
                        hkdToTwdRate = rate;
                        console.log(`Exchange Rate (HKD->TWD) fetched: ${hkdToTwdRate}`);
                        return rate;
                    }
                }
                console.warn("Failed to parse valid exchange rate from API response:", text);

            } catch (error) {
                console.error(`Attempt ${i + 1} failed for exchange rate:`, error.message);
                if (i === retries - 1) {
                    console.error("Failed to fetch exchange rate after all retries.");
                    break;
                }
                const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }

        // å¦‚æœæ‰€æœ‰å˜—è©¦éƒ½å¤±æ•—ï¼Œè¨­å®šä¸€å€‹é è¨­å€¼ (ä¾‹å¦‚ 4.0)
        if (hkdToTwdRate === null) {
            hkdToTwdRate = 4.0;
            console.warn(`ä½¿ç”¨é è¨­å‚™ç”¨åŒ¯ç‡: ${hkdToTwdRate}`);
        }
        return hkdToTwdRate;
    }


    // --- 3. Firestore è¨˜å¸³æ“ä½œ (ä¸è®Š) ---

    function listenForExpenses() {
        if (!isAuthReady || !userId) return;

        const expensesQuery = getExpensesCollection(userId);
        
        onSnapshot(expensesQuery, (snapshot) => {
            expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // æ”¶åˆ°æ–°è³‡æ–™å¾Œï¼Œé‡æ–°æ¸²æŸ“ç•¶å‰é é¢å’Œç¸½è¨ˆ
            renderItinerary();
            calculateGrandTotal();
        }, (error) => {
            console.error("Error listening to expenses:", error);
        });
    }

    async function addExpense(day, item, amount) {
        if (!isAuthReady || !userId || !item || !amount) return;
        
        const amountFloat = parseFloat(amount);
        if (isNaN(amountFloat) || amountFloat <= 0) {
            console.warn("é‡‘é¡ç„¡æ•ˆã€‚");
            return;
        }

        const expenseData = {
            day: day,
            item: item,
            amount: amountFloat,
            timestamp: serverTimestamp()
        };

        try {
            await addDoc(getExpensesCollection(userId), expenseData);
        } catch (error) {
            console.error("Error adding document: ", error);
        }
    }

    async function deleteExpense(expenseId) {
        if (!isAuthReady || !userId || !expenseId) return;

        try {
            const docRef = doc(getExpensesCollection(userId), expenseId);
            await deleteDoc(docRef);
        } catch (error) {
            console.error("Error deleting document: ", error);
        }
    }
    
    // --- 4. æ ¸å¿ƒåŠŸèƒ½èˆ‡æ¸²æŸ“ ---

    function calculateGrandTotal() {
        const totalHKD = expenses.reduce((sum, expense) => sum + expense.amount, 0);
        let grandTotalDisplay = `HK$ ${totalHKD.toFixed(2)}`;
        
        // NEW: åŒ¯ç‡æ›ç®—ä¸¦é¡¯ç¤ºå°å¹£ç¸½é¡
        if (hkdToTwdRate) {
            const totalTWD = totalHKD * hkdToTwdRate;
            grandTotalDisplay += ` / NT$ ${totalTWD.toFixed(0)}`; // å°å¹£é€šå¸¸å–æ•´æ•¸
        }

        document.getElementById('grand-total').textContent = grandTotalDisplay;
        
        // å‹•æ…‹èª¿æ•´ Nav Bar çš„å›ºå®šä½ç½®
        const headerHeight = document.getElementById('main-header').offsetHeight;
        document.getElementById('day-nav-bar').style.top = `${headerHeight}px`;
    }
    
    // è¡Œç¨‹æ•¸æ“š (ä¿æŒä¸è®Š)
    const itinerary = [
        {
            day: 1,
            date: "Day 1",
            items: [
                { time: "11:00", type: "transport", name: "é¦™æ¸¯èˆªç©º", detail: "æŠµé”é¦™æ¸¯åœ‹éš›æ©Ÿå ´ï¼Œå‡ç´šå•†å‹™è‰™", icon: "âœˆï¸" },
                { time: "12:00", type: "transport", name: "A11 å·´å£«", detail: "æ­ä¹˜å…¬è»Šå‰å¾€ä¸Šç’°é£¯åº—", icon: "ğŸšŒ" },
                { time: "13:00", type: "attraction", name: "å¯Œè•™ä¸Šç’°é…’åº— (Check-in)", detail: "è¾¦ç†å…¥ä½æ‰‹çºŒ", icon: "ğŸ¨" },
                { time: "14:00", type: "attraction", name: "è˜­èŠ³åœ’ (ä¸­ç’°)", detail: "å–ç¶“å…¸çµ²è¥ªå¥¶èŒ¶æˆ–å‡é£²", icon: "ğŸ¥¤" },
                { time: "14:30", type: "attraction", name: "ä¸€æ¨‚ç‡’é´¨", detail: "ç±³å…¶æ—æ¨è–¦ç‡’è‡˜åˆé¤", icon: "ğŸ–" },
                { time: "16:00", type: "attraction", name: "ä¸­ç’°è¡—å¸‚", detail: "åƒè§€æ´»åŒ–æ­·å²å»ºç¯‰èˆ‡ç‰¹è‰²å°åº—", icon: "ğŸ›ï¸" },
                { time: "17:30", type: "attraction", name: "å¤§é¤¨ (ç›£ç„èˆŠå€)", detail: "è—è¡“ã€æ­·å²ã€chill çš„å¥½åœ°æ–¹", icon: "ğŸ›ï¸" },
                { time: "20:00", type: "attraction", name: "æ¥šç„¶è¨˜å¤§æ’æª”", detail: "é«”é©—åœ°é“æ¸¯å¼æ™šé¤", icon: "ğŸœ" },
            ]
        },
        {
            day: 2,
            date: "Day 2",
            items: [
                { time: "09:30", type: "transport", name: "åœ°éµ", detail: "å‰å¾€å …å°¼åœ°åŸ", icon: "ğŸš‡" },
                { time: "10:00", type: "attraction", name: "å …å°¼åœ°åŸæµ·æ—", detail: "ç¶²ç¾æ‹ç…§æ‰“å¡é»", icon: "ğŸ“¸" },
                { time: "11:30", type: "transport", name: "æ­èˆ¹ (æ¸¯æ¾³ç¢¼é ­)", detail: "å‰å¾€æ¾³é–€æ°¹ä»”å®¢é‹ç¢¼é ­", icon: "ğŸš¢" },
                { time: "13:00", type: "attraction", name: "åˆ©è»’å†°å®¤ (æ¾³é–€)", detail: "æ¾³é–€èŒ¶é¤å»³ç¾é£Ÿåˆé¤", icon: "ğŸ½ï¸" },
                { time: "15:00", type: "attraction", name: "å¨å°¼æ–¯äººé…’åº— (æ¾³é–€)", detail: "å®‰å¾·é­¯è›‹æ’» & è³­ $100 å°è©¦æ‰‹æ°£", icon: "ğŸ°" },
                { time: "17:00", type: "transport", name: "æ¥é§è»Š", detail: "å¾€æ¾³é–€å¤–æ¸¯ç¢¼é ­æº–å‚™å›ç¨‹", icon: "ğŸšŒ" },
                { time: "19:00", type: "attraction", name: "é‡‘ç¾é£Ÿ & æé¦™åœ’ (æ¾³é–€)", detail: "æ™šé¤æ›¿ä»£é¸æ“‡", icon: "ğŸ²" },
                { time: "21:00", type: "transport", name: "æ¸¯ç æ¾³å¤§æ©‹ (é‡‘å±±å·´å£«)", detail: "æ­é‡‘å±±å·´å£«å›é¦™æ¸¯ (å…¥å¢ƒå°æ’æ›²)", icon: "ğŸŒ‰" },
                { time: "22:30", type: "transport", name: "A11 å·´å£«", detail: "å›ä¸Šç’°é£¯åº—ä¼‘æ¯", icon: "ğŸ¨" },
            ]
        },
        {
            day: 3,
            date: "Day 3",
            items: [
                { time: "09:00", type: "attraction", name: "ç‘è¨˜å’–å•¡ (ä¸Šç’°)", detail: "æ—©é¤ (å¥¶èŒ¶ã€è¥¿å¤šå£«)", icon: "ğŸ¥ª" },
                { time: "10:30", type: "transport", name: "åœ°éµ", detail: "å‰å¾€æ—ºè§’/å¤ªå­ä¸€å¸¶", icon: "ğŸš‡" },
                { time: "11:00", type: "attraction", name: "æ—¦ç‹ & æ¤°æ±å¤§ç‹", detail: "æ—ºè§’è¡—é ­å°åƒå·¡ç¦®", icon: "ğŸ¥š" },
                { time: "12:30", type: "attraction", name: "é»‘åœ° (Blackground) & å¤ªå­", detail: "æ½®æµæœé£¾ã€ç‰¹è‰²å°åº—é€›è¡—", icon: "ğŸ‘•" },
                { time: "14:00", type: "attraction", name: "TWEMCO ç¿»é é˜", detail: "è³¼è²·ç¶“å…¸è¨­è¨ˆæ™‚é˜", icon: "ğŸ•°ï¸" },
                { time: "16:00", type: "attraction", name: "K11 MUSEA (å°–æ²™å’€)", detail: "åƒè§€å•†å ´ã€æ½®æµè—è¡“å±•è¦½", icon: "ğŸ–¼ï¸" },
                { time: "17:30", type: "attraction", name: "ç´…èŒ¶ (Tea)", detail: "ç²¾ç·»ä¸‹åˆèŒ¶æˆ–é£²æ–™", icon: "â˜•" },
                { time: "19:30", type: "attraction", name: "åœ°èŒ‚é¤¨ç”œå“", detail: "æ™šé¤å¾Œçš„æ¸¯å¼ç”œé»æ™‚é–“", icon: "ğŸ§" },
            ]
        },
        {
            day: 4,
            date: "Day 4",
            items: [
                { time: "09:00", type: "attraction", name: "ç§‘è¨˜å’–å•¡èŒ¶å»³ (ä¸Šç’°)", detail: "æ—©é¤ (è±¬æ‰’åŒ…ã€è”¥æ²¹æ’ˆéºµ)", icon: "ğŸ¥–" },
                { time: "10:30", type: "attraction", name: "æ¾³æ´²ç‰›å¥¶å…¬å¸ (ä½æ•¦)", detail: "å¿…åƒæ‹›ç‰Œç‚’è›‹å¤šå£« (çœŸçš„è®š)", icon: "ğŸ³" },
                { time: "12:00", type: "attraction", name: "K11 hashtag B", detail: "å†è¨ªï¼Œçµ‚æ–¼è²·åˆ°è›‹å¡”ï¼", icon: "ğŸ¥§" },
                { time: "13:30", type: "attraction", name: "è¯å«‚ & å¸è‹‘é¤…åº—", detail: "å¤–å¸¶è¯å«‚ç¾é£Ÿï¼Œè³¼è²·è´è¶é…¥ä¼´æ‰‹ç¦®", icon: "ğŸ¥¡" },
                { time: "15:00", type: "transport", name: "å›ç¨‹", detail: "å‰å¾€æ©Ÿå ´æº–å‚™ç™»æ©Ÿï¼Œæ—…ç¨‹çµæŸ", icon: "ğŸ›«" },
            ]
        },
        // å¯¦ç”¨è³‡è¨Š (Day 5)
        {
            day: INFO_PAGE_DAY,
            date: "Day 5",
            items: []
        }
    ];
    
    // å¯¦ç”¨è³‡è¨Šå…§å®¹ (ä¿æŒä¸è®Š)
    const toolInfoContent = `
        <div class="space-y-4">
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-700">ç°½è­‰èˆ‡æ–‡ä»¶ (é¦™æ¸¯)</span>
                <p class="mt-2 text-sm leading-relaxed text-gray-700">å°ç£æ—…å®¢ï¼šæŒæœ‰æ•ˆè­‰ä»¶ï¼ˆå¦‚å°èƒè­‰æˆ–è­·ç…§+ç¶²ä¸Šé è¾¦å…¥å¢ƒç™»è¨˜ï¼‰ï¼Œé€šå¸¸å¯å…ç°½åœç•™7è‡³30å¤©ã€‚**Day 2 æé†’æ‚¨ï¼Œå…¥å¢ƒæ–‡ä»¶å½±æœ¬æˆ–é›»å­æª”æœ€å¥½å‚™å¦¥ï¼Œä»¥é˜²æŸ¥é©—éœ€è¦ã€‚**</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-700">è¡£è‘—å»ºè­°</span>
                <p class="mt-2 text-sm leading-relaxed text-gray-700">é¦™æ¸¯åœ°éµèˆ‡å•†å ´å†·æ°£æ¥µå¼·ï¼Œå»ºè­°æ¡ç”¨**å¤šå±¤æ¬¡ç©¿æ­**ã€‚éš¨èº«æ”œå¸¶è–„å¤–å¥—æ˜¯å¿…é ˆçš„ï¼</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-700">ç¶²è·¯é›»ä¿¡æ¨è–¦</span>
                <p class="mt-2 text-sm leading-relaxed text-gray-700">æ¨è–¦ä½¿ç”¨ **eSIM (å¦‚ Airalo)** æˆ–åœ¨æ©Ÿå ´/ä¾¿åˆ©åº—è³¼è²·ç•¶åœ°çš„é ä»˜å¡ (å¦‚ csl, 3HK)ï¼Œç¢ºä¿ç¶²è·¯é †æš¢ã€‚</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-700">é˜²é¨™ç§˜ç¬ˆ</span>
                <p class="mt-2 text-sm leading-relaxed text-gray-700">1. **æ‰¾é›¶ï¼š** åœ¨èˆŠå¼èŒ¶é¤å»³æˆ–è¡—é‚Šæ”¤è²©ä»˜ç¾é‡‘ï¼Œå‹™å¿…ç•¶é¢é»æ¸…æ‰¾é›¶ã€‚2. **è³¼ç‰©ï¼š** è³¼è²·é›»å­ç”¢å“è«‹é¸æ“‡å¤§å‹ã€ä¿¡è­½è‰¯å¥½çš„é€£é–åº—ã€‚</p>
            </div>
             <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full bg-pink-100 text-pink-700">å¿…è²·ç´€å¿µå“ä¼´æ‰‹ç¦®</span>
                <p class="mt-2 text-sm leading-relaxed text-gray-700">æ‚¨çš„è¡Œç¨‹å·²åŒ…å«ï¼š**å¸è‹‘é¤…åº—è´è¶é…¥**ï¼ˆå¼·çƒˆæ¨è–¦ï¼ï¼‰ã€‚å…¶ä»–å¯è€ƒæ…®ï¼šçå¦®æ›²å¥‡ã€æª¸æª¬ç‹ã€‚</p>
            </div>
        </div>
    `;

    // --- NEW: è™•ç†æ—¥æœŸé¸æ“‡çš„å‡½æ•¸ (ä¿æŒä¸è®Š) ---
    function selectDay(element, day) {
        // 1. ç§»é™¤æ‰€æœ‰é …ç›®çš„é¸ä¸­æ¨£å¼
        document.querySelectorAll('.day-item-inner').forEach(item => {
            item.classList.remove('active');
            item.classList.add('inactive');
        });

        // 2. æ·»åŠ é¸ä¸­æ¨£å¼
        element.classList.add('active');
        element.classList.remove('inactive');

        // 3. æ»¾å‹•åˆ°é¸ä¸­çš„é …ç›®ï¼ˆä½¿å…¶å±…ä¸­é¡¯ç¤ºï¼‰
        element.parentElement.scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
            inline: 'center'
        });

        // 4. åˆ‡æ›æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ (åªåœ¨é¸ä¸­çš„ Day ä¸åŒæ™‚æ‰åˆ‡æ›ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“)
        if (currentDay !== day) {
            switchDay(day); 
        }
    }

    // æ¸²æŸ“å°èˆª Tab (Segmented Control)
    function renderNavigation() {
        const navContainer = document.getElementById('day-navigation');
        navContainer.innerHTML = '';
        
        const daysToRender = [1, 2, 3, 4, INFO_PAGE_DAY]; // Day 1-4 + å¯¦ç”¨è³‡è¨Š

        daysToRender.forEach((day) => {
            const label = dayLabels[day];
            const isCurrent = day === currentDay;

            const dateItem = document.createElement('div');
            // æ ¸å¿ƒï¼šä½¿ç”¨ w-1/5 (20%) é…åˆ flex-shrink-0 å¯¦ç¾äº”ç­‰åˆ†ï¼Œä¸¦ç”¨ snap-center å¯¦ç¾å±…ä¸­æ»¾å‹•é–å®š
            dateItem.className = `day-item w-1/5 flex-shrink-0 snap-center p-1 md:p-2 cursor-pointer transition duration-200 transform`;

            // å…§éƒ¨å…§å®¹ï¼šç”¨æ–¼è¦–è¦ºæ¨£å¼å’Œé–“è·
            const innerContent = document.createElement('div');
            innerContent.className = `day-item-inner ${isCurrent ? 'active' : 'inactive'}`;
            innerContent.innerHTML = `<span class="text-base">${label}</span>`;
            
            // é»æ“Šæ™‚ï¼Œèª¿ç”¨ selectDay è™•ç†æ¨£å¼å’Œæ»¾å‹•ï¼ŒselectDay å…§éƒ¨æœƒèª¿ç”¨ switchDay è™•ç†è³‡æ–™
            innerContent.onclick = () => selectDay(innerContent, day);
            
            dateItem.appendChild(innerContent);
            navContainer.appendChild(dateItem);
        });

        calculateGrandTotal(); 
        
        // ç¢ºä¿åˆå§‹é¸ä¸­çš„ Day 1 ä½æ–¼ä¸­å¤®
        const firstDayElement = navContainer.querySelector('.day-item-inner.active');
        if (firstDayElement) {
            firstDayElement.parentElement.scrollIntoView({
                behavior: 'auto',
                block: 'nearest',
                inline: 'center'
            });
        }
    }

    // æ¸²æŸ“ç•¶æ—¥è¡Œç¨‹èˆ‡è¨˜å¸³å€å¡Š
    function renderItinerary() {
        if (!isAuthReady) return; 

        const container = document.getElementById('itinerary-cards');
        container.innerHTML = '';

        if (currentDay === INFO_PAGE_DAY) {
            // --- æ¸²æŸ“å¯¦ç”¨è³‡è¨Šåˆ†é  ---
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 bg-white rounded-xl shadow-lg border border-gray-100">
                        <h2 class="text-xl font-bold text-gray-800 pb-2 border-b border-gray-200 flex items-center mb-4 text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                            é¦™æ¸¯æ—…éŠå¯¦ç”¨è³‡è¨Š
                        </h2>
                        ${toolInfoContent}
                    </div>
                </div>
            `;
            return;
        }


        // --- æ¸²æŸ“æ¯æ—¥è¡Œç¨‹åˆ†é  (Day 1-4) ---
        const dayPlan = itinerary.find(d => d.day === currentDay);
        if (!dayPlan) return;

        // æ¯æ—¥è¡Œç¨‹åˆ—è¡¨
        const itineraryList = document.createElement('div');
        itineraryList.className = 'space-y-2'; // å¢åŠ è¡Œç¨‹é–“çš„å‚ç›´é–“è·
        
        dayPlan.items.forEach((item, index) => {
            const isAttraction = item.type === 'attraction';
            
            const itemContainer = document.createElement('div');
            itemContainer.className = 'itinerary-item'; // ä½¿ç”¨æ™‚é–“è»¸æ¨£å¼
            
            const card = document.createElement('div');
            card.id = `item-${dayPlan.day}-${index}`;
            const cardBorderColor = isAttraction ? 'card-attraction' : 'card-transport';
            
            card.className = `itinerary-card ${cardBorderColor}`;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <p class="text-xs font-medium text-gray-400 mb-0.5">æ™‚é–“</p>
                        <p class="text-2xl font-extrabold text-gray-800 leading-none">${item.time}</p>
                    </div>
                    <span class="text-3xl flex-shrink-0">${item.icon}</span>
                </div>
                
                <h3 class="text-base font-bold text-gray-800 mt-2">${item.name}</h3>
                <p class="text-sm text-gray-500 mt-1">${item.detail}</p>
                
                <!-- Story Button -->
                ${isAttraction ? `
                    <button class='text-pink-600 hover:text-pink-700 focus:outline-none text-xs mt-3 px-3 py-1 border border-pink-600 rounded-full transition duration-150 flex-shrink-0 bg-pink-50/50 active:scale-95' 
                            onclick="toggleInfo('info-${dayPlan.day}-${index}', '${item.name}', this, 'item-${dayPlan.day}-${index}')">
                        æ•…äº‹ ğŸ”½
                    </button>` : ''}
                
                <!-- Info Panel will be inserted here -->
            `;

            // æ™¯é»æ•…äº‹å€å¡Š
            if (isAttraction) {
                const infoPanel = document.createElement('div');
                infoPanel.id = `info-${dayPlan.day}-${index}`;
                infoPanel.className = 'mt-3 pt-3 border-t border-gray-100 text-sm hidden w-full';
                card.appendChild(infoPanel);
            }
            
            itemContainer.appendChild(card);
            itineraryList.appendChild(itemContainer);
        });
        
        container.appendChild(itineraryList);

        // åŠ å…¥è¨˜å¸³å€å¡Š
        const budgetWrapper = document.createElement('div');
        budgetWrapper.className = 'mt-8 pb-10';
        budgetWrapper.appendChild(renderBudgetSection(dayPlan));
        container.appendChild(budgetWrapper);
    }

    // æ¸²æŸ“è¨˜å¸³å€å¡Š
    function renderBudgetSection(dayPlan) {
        const day = dayPlan.day; 
        const section = document.createElement('section');
        section.className = 'p-5 bg-gray-50 rounded-xl shadow-inner border border-gray-200 space-y-4';
        
        // éæ¿¾ä¸¦æ’åºç•¶æ—¥æ”¯å‡º (æœ€æ–°æ”¯å‡ºåœ¨æœ€ä¸Šé¢)
        const dayExpenses = expenses.filter(e => e.day === day).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        const dailyTotalHKD = dayExpenses.reduce((sum, e) => sum + e.amount, 0);

        let dailyTotalDisplay = `ç¸½è¨ˆ: HK$ ${dailyTotalHKD.toFixed(2)}`;
        
        // NEW: åŒ¯ç‡æ›ç®—
        let twdRateDisplay = '';
        if (hkdToTwdRate) {
            const dailyTotalTWD = dailyTotalHKD * hkdToTwdRate;
            dailyTotalDisplay += ` / NT$ ${dailyTotalTWD.toFixed(0)}`;
            twdRateDisplay = `(1 HKD â‰ˆ NT$ ${hkdToTwdRate.toFixed(2)})`;
        }

        // è¨˜å¸³æ¨™é¡Œèˆ‡ç¸½é¡
        section.innerHTML = `
            <div class="flex justify-between items-start pb-2 border-b border-gray-300">
                <div>
                    <h3 class="text-lg font-bold text-gray-800 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2 -mt-0.5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2 2v4a2 2 0 002 2h2a2 2 0 002-2V6a2 2 0 00-2-2H4zm10 8V6h2v6h-2z" clip-rule="evenodd" />
                        </svg>
                        ${dayPlan.date} è¨˜å¸³æ‰‹å†Š
                    </h3>
                    <p class="text-xs text-gray-500 mt-1">${twdRateDisplay}</p>
                </div>
                <p class="text-xl font-extrabold text-red-600">${dailyTotalDisplay}</p>
            </div>
            <form id="add-expense-form-day-${day}" class="flex flex-col space-y-3">
                <div class="flex space-x-2">
                    <input type="text" id="expense-item" placeholder="é …ç›® (e.g. ç‡’é´¨é£¯)" required class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm shadow-inner bg-white">
                    <input type="number" id="expense-amount" placeholder="é‡‘é¡ (HK$)" required min="0.01" step="0.01" class="w-28 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm shadow-inner bg-white">
                </div>
                <button type="submit" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 text-sm font-semibold shadow-md active:scale-[0.98]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 -mt-0.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    æ–°å¢ä¸€ç­†æ”¯å‡º
                </button>
            </form>
            <div id="expense-list-day-${day}" class="space-y-2 max-h-60 overflow-y-auto">
                ${dayExpenses.length === 0 ? '<p class="text-center text-gray-500 italic p-4 bg-white rounded-lg shadow-sm border border-gray-100">æœ¬é å°šæœªæœ‰æ”¯å‡ºç´€éŒ„ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹è¨˜éŒ„ï¼</p>' : ''}
                ${dayExpenses.map(e => {
                    const hkdAmount = e.amount.toFixed(2);
                    let twdDisplay = '';
                    if (hkdToTwdRate) {
                        const twdAmount = (e.amount * hkdToTwdRate).toFixed(0);
                        twdDisplay = `(ç´„ NT$ ${twdAmount})`;
                    }

                    return `
                        <div class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-gray-100">
                            <span class="text-sm font-medium text-gray-800 truncate flex-1">${e.item}</span>
                            <div class="flex items-center space-x-3 flex-shrink-0">
                                <span class="text-sm font-bold text-red-500">HK$ ${hkdAmount} ${twdDisplay}</span>
                                <button onclick="deleteExpense('${e.id}')" class="text-gray-400 hover:text-red-600 transition duration-150 p-1 rounded-full bg-gray-50 flex-shrink-0 active:scale-90" title="åˆªé™¤">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        // ç¶å®šè¡¨å–®æäº¤äº‹ä»¶
        const form = section.querySelector(`#add-expense-form-day-${day}`);
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const item = form.querySelector('#expense-item').value.trim();
            const amount = form.querySelector('#expense-amount').value;

            if (item && parseFloat(amount) > 0) {
                addExpense(day, item, amount);
                form.reset(); // æ¸…ç©ºè¡¨å–®
            } else {
                // ä½¿ç”¨æ¨¡æ“¬ Modal æˆ– Toast æ›¿ä»£ alert()
                console.warn("è«‹è¼¸å…¥æœ‰æ•ˆçš„é …ç›®åç¨±å’Œé‡‘é¡ã€‚");
            }
        });

        return section;
    }

    // åˆ‡æ›æ—¥æœŸ (åªæ›´æ–°ç‹€æ…‹ä¸¦é‡æ–°æ¸²æŸ“è¡Œç¨‹)
    function switchDay(day) {
        currentDay = day;
        renderItinerary();
        document.getElementById('app').scrollTop = 0; // æ²å‹•åˆ°é ‚éƒ¨
    }

    // æ™¯é»æ•…äº‹å±•é–‹/æ”¶åˆ (ä¿æŒä¸è®Š)
    async function toggleInfo(infoPanelId, attractionName, buttonElement, cardId) {
        const infoPanel = document.getElementById(infoPanelId);
        const card = document.getElementById(cardId);

        // ç¢ºä¿åœ¨é¦–æ¬¡è¼‰å…¥æ™‚é¡¯ç¤º Loading
        if (!infoPanel.innerHTML.includes('è¼‰å…¥æ™¯é»æ•…äº‹') && !loadedContent[attractionName]) {
            infoPanel.innerHTML = `
                <p class="text-gray-400 flex items-center">
                    <span class="loading-dot w-1.5 h-1.5 bg-blue-400 rounded-full mr-1.5"></span>
                    <span class="loading-dot w-1.5 h-1.5 bg-blue-400 rounded-full mr-1.5"></span>
                    <span class="loading-dot w-1.5 h-1.5 bg-blue-400 rounded-full"></span>
                    è¼‰å…¥æ™¯é»æ•…äº‹èˆ‡æ”»ç•¥ä¸­...
                </p>
            `;
        }

        if (infoPanel.classList.contains('hidden')) {
            infoPanel.classList.remove('hidden');
            buttonElement.innerHTML = 'æ”¶åˆ ğŸ”¼';
            card.classList.add('shadow-xl'); // å±•é–‹æ™‚å¼·èª¿å¡ç‰‡

            if (loadedContent[attractionName]) {
                infoPanel.innerHTML = loadedContent[attractionName].text + loadedContent[attractionName].sources;
                return;
            }

            const query = `é¦™æ¸¯æ™¯é»ï¼š${attractionName}`;
            const result = await callGeminiApi(query);
            
            // å¦‚æœæˆåŠŸè¼‰å…¥ï¼Œæ ¼å¼åŒ–æ–‡æœ¬ä¸¦ç·©å­˜
            let formattedText = result.text.replace(/\n\s*\n/g, '<br><br>').replace(/\n/g, ' ');

            loadedContent[attractionName] = { text: formattedText, sources: result.sources };
            
            infoPanel.innerHTML = `
                <div class="text-gray-700">${formattedText}</div>
                ${result.sources}
            `;

        } else {
            infoPanel.classList.add('hidden');
            buttonElement.innerHTML = 'æ•…äº‹ ğŸ”½';
            card.classList.remove('shadow-xl'); // æ”¶åˆæ™‚æ¢å¾©é è¨­é™°å½±
        }
    }
    
    // å°‡æ ¸å¿ƒåŠŸèƒ½å…¬é–‹åˆ°å…¨åŸŸ (ä¾› HTML å…§è¯äº‹ä»¶èª¿ç”¨)
    window.switchDay = switchDay;
    window.deleteExpense = deleteExpense;
    window.toggleInfo = toggleInfo;
    
    // --- 5. Gemini API å‘¼å«å‡½å¼ (ä¿æŒä¸è®Š) ---
    async function callGeminiApi(query, retries = 3) {
        // ç‚ºæ•…äº‹åŠŸèƒ½å®šç¾©çš„ç³»çµ±æç¤º
        const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„é¦™æ¸¯æ—…éŠé¡§å•ï¼Œè«‹æ ¹æ“šç”¨æˆ¶æä¾›çš„æ™¯é»åç¨±ï¼Œä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œ Google æœå°‹çµæœï¼Œæä¾›ç´„ 150 å­—çš„æ™¯é»æ•…äº‹ã€æ–‡åŒ–èƒŒæ™¯æˆ–å¯¦ç”¨æ—…éŠæ”»ç•¥ï¼Œä»¥ Markdown æ ¼å¼è¼¸å‡ºã€‚";
        const payload = {
            contents: [{ parts: [{ text: query }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429) {
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                }

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error(`Gemini API HTTP Error! Status: ${response.status}. Body: ${errorBody}`);
                    throw new Error(`API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`); 
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;

                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title, }))
                            .filter(source => source.uri && source.title);
                    }
                    
                    const sourceHtml = sources.map(s => `<a href="${s.uri}" target="_blank" class="text-xs text-blue-500 hover:text-blue-700 truncate block">ğŸ”— ${s.title}</a>`).join('');
                    
                    return {
                        text: text,
                        sources: sources.length > 0 ? `<div class="mt-2 pt-2 border-t border-gray-100 text-gray-500">ä¾†æºåƒè€ƒï¼š<div class="space-y-1">${sourceHtml}</div></div>` : ''
                    };
                }
                // å¦‚æœ API æˆåŠŸï¼Œä½†æ¨¡å‹æ²’æœ‰è¿”å›å…§å®¹
                return { text: "æœªèƒ½ç²å–æ™¯é»è³‡è¨Šï¼Œæ¨¡å‹ç„¡å›æ‡‰ã€‚", sources: "" }; 

            } catch (error) {
                console.error(`Attempt ${i + 1} failed for ${query}:`, error.message);
                if (i === retries - 1) {
                    const errorMessage = error.message.includes("API è«‹æ±‚å¤±æ•—") ? error.message : "è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– API ç‹€æ…‹ã€‚";
                    return { text: `æ™¯é»è³‡è¨Šè¼‰å…¥å¤±æ•—ï¼ŒéŒ¯èª¤è¨Šæ¯: ${errorMessage}`, sources: "" };
                }
                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
        // æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—
        return { text: "æ™¯é»è³‡è¨Šè¼‰å…¥å¤±æ•—ï¼Œå·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ã€‚", sources: "" };
    }


    // --- 6. åˆå§‹åŒ–æ‡‰ç”¨ ---
    window.onload = () => {
        initFirebase();
    };

</script>

</body>
</html>

